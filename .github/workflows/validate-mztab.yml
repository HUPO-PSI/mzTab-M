name: Validate mzTab-M Files

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Download jmzTab-m CLI
      run: |
        # Download the latest stable version of jmzTab-m CLI
        VERSION="1.0.6"
        CLI_URL="https://repo1.maven.org/maven2/de/isas/mztab/jmztabm-cli/${VERSION}/jmztabm-cli-${VERSION}.jar"
        
        echo "Downloading jmzTab-m CLI version ${VERSION}..."
        wget -q "${CLI_URL}" -O jmztabm-cli-${VERSION}.jar
        
        CLI_JAR="jmztabm-cli-${VERSION}.jar"
        echo "Downloaded CLI jar: ${CLI_JAR}"
        echo "CLI_JAR=${CLI_JAR}" >> $GITHUB_ENV

    - name: Validate MTBLS263.mztab
      run: |
        echo "Validating examples/MTBLS263.mztab with Info level logging..."
        java -jar "${CLI_JAR}" -c examples/MTBLS263.mztab -l Info
        
        echo "Validation completed successfully!"
        
    - name: Validate all mzTab files
      shell: bash {0}
      run: |
        set +e
        echo "Validating all .mztab and .json files in the repository..."
        
        # Count files
        mztab_count=$(find . -name "*.mztab" -type f | wc -l)
        json_count=$(find . -name "*.json" -type f | wc -l)
        
        echo "Found ${mztab_count} .mztab files and ${json_count} .json files"
        
        success_count=0
        failed_count=0
        
        # Validate .mztab files
        if [ $mztab_count -gt 0 ]; then
          echo "=== Validating .mztab files ==="
          find . -name "*.mztab" -type f | while read -r file; do
            echo "Validating: $file"
            if java -jar "${CLI_JAR}" -c "$file" -l Info; then
              echo "✓ $file - PASSED"
              ((success_count++))
            else
              echo "✗ $file - FAILED"
              ((failed_count++))
            fi
            echo "---"
          done
        fi
        
        # Validate .json files (if any exist and appear to be mzTab-M JSON)
        if [ $json_count -gt 0 ]; then
          echo "=== Validating .json files ==="
          find . -name "*.json" -type f | while read -r file; do
            # Check if file contains mzTab-M JSON structure
            if grep -q '"mzTab"' "$file" 2>/dev/null; then
              echo "Validating mzTab-M JSON: $file"
              if java -jar "${CLI_JAR}" -c "$file" --fromJson -l Info; then
                echo "✓ $file - PASSED"
                ((success_count++))
              else
                echo "✗ $file - FAILED"
                ((failed_count++))
              fi
            else
              echo "ℹ Skipping $file (not a mzTab-M JSON file)"
            fi
            echo "---"
          done
        fi
        
        echo "=== Validation Summary ==="
        echo "Total files processed: $((success_count + failed_count))"
        echo "Successful validations: $success_count"
        echo "Failed validations: $failed_count"
        if [[ $failed_count -gt 0 ]]; then
          exit 1
        else
          exit 0
        fi
