name: Validate mzTab-M Files

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Download jmzTab-m CLI
      run: |
        # Download the latest stable version of jmzTab-m CLI
        VERSION="1.0.6"
        CLI_URL="https://repo1.maven.org/maven2/de/isas/mztab/jmztabm-cli/${VERSION}/jmztabm-cli-${VERSION}.jar"
        
        echo "Downloading jmzTab-m CLI version ${VERSION}..."
        wget -q "${CLI_URL}" -O jmztabm-cli-${VERSION}.jar
        
        echo "Downloaded CLI jar: jmztabm-cli-${VERSION}.jar"

    - name: Validate MTBLS263.mztab
      run: |
        echo "Validating examples/MTBLS263.mztab with Info level logging..."
        java -jar "jmztabm-cli-1.0.6.jar" -c examples/MTBLS263.mztab -l Info
        
        echo "Validation completed successfully!"
        
    - name: Validate all mzTab files
      run: |
        echo "Validating all .mztab and .json files in the repository..."
        
        # Count files
        mztab_count=$(find . -name "*.mztab" -type f | wc -l)
        json_count=$(find . -name "*.json" -type f | wc -l)
        
        echo "Found ${mztab_count} .mztab files and ${json_count} .json files"
        
        success_count=0
        failed_count=0
        cli_error_count=0
        
        # Validate .mztab files using process substitution to avoid subshell variable issues
        if [ $mztab_count -gt 0 ]; then
          echo "=== Validating .mztab files ==="
          while IFS= read -r -d '' file; do
            echo "Validating: $file"
            if java -jar "jmztabm-cli-1.0.6.jar" -c "$file" -l Info; then
              echo "✓ $file - PASSED validation"
              ((success_count++))
              echo "DEBUG: success_count is now $success_count"
            else
              exit_code=$?
              if [ $exit_code -eq 1 ]; then
                echo "✗ $file - FAILED validation (contains validation errors)"
                ((failed_count++))
                echo "DEBUG: failed_count is now $failed_count"
              else
                echo "✗ $file - CLI ERROR (exit code: $exit_code)"
                ((cli_error_count++))
                echo "DEBUG: cli_error_count is now $cli_error_count"
              fi
            fi
            echo "---"
          done < <(find . -name "*.mztab" -type f -print0)
        fi
        
        # Validate .json files (if any exist and appear to be mzTab-M JSON)
        if [ $json_count -gt 0 ]; then
          echo "=== Validating .json files ==="
          while IFS= read -r -d '' file; do
            # Check if file contains mzTab-M JSON structure
            if grep -q '"mzTab"' "$file" 2>/dev/null; then
              echo "Validating mzTab-M JSON: $file"
              if java -jar "jmztabm-cli-1.0.6.jar" -c "$file" --fromJson -l Info; then
                echo "✓ $file - PASSED validation"
                ((success_count++))
                echo "DEBUG: success_count is now $success_count"
              else
                exit_code=$?
                if [ $exit_code -eq 1 ]; then
                  echo "✗ $file - FAILED validation (contains validation errors)"
                  ((failed_count++))
                  echo "DEBUG: failed_count is now $failed_count"
                else
                  echo "✗ $file - CLI ERROR (exit code: $exit_code)"
                  ((cli_error_count++))
                  echo "DEBUG: cli_error_count is now $cli_error_count"
                fi
              fi
            else
              echo "ℹ Skipping $file (not a mzTab-M JSON file)"
            fi
            echo "---"
          done < <(find . -name "*.json" -type f -print0)
        fi
        
        echo "=== Validation Summary ==="
        
        # Debug: Print variable values before arithmetic
        echo "DEBUG: Before summary calculations:"
        echo "DEBUG: success_count='$success_count'"
        echo "DEBUG: failed_count='$failed_count'"
        echo "DEBUG: cli_error_count='$cli_error_count'"
        
        # Ensure variables are properly initialized for arithmetic
        : ${success_count:=0}
        : ${failed_count:=0}
        : ${cli_error_count:=0}
        
        echo "DEBUG: After initialization:"
        echo "DEBUG: success_count='$success_count'"
        echo "DEBUG: failed_count='$failed_count'"
        echo "DEBUG: cli_error_count='$cli_error_count'"
        
        total_processed=$((success_count + failed_count + cli_error_count))
        echo "Total files processed: $total_processed"
        echo "Successful validations: $success_count"
        echo "Failed validations (validation errors): $failed_count"
        echo "CLI errors: $cli_error_count"
        
        # Only fail the workflow if there were CLI errors (unexpected failures)
        # Validation errors are expected for some files (like minimal-m-2.0.mztab)
        if [[ $cli_error_count -gt 0 ]]; then
          echo "❌ Workflow failed due to CLI errors"
          exit 1
        else
          echo "✅ Workflow completed successfully"
          echo "Note: Files with validation errors are expected (e.g., minimal-m-2.0.mztab demonstrates validation errors)"
          exit 0
        fi
