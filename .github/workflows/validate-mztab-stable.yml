name: Validate v2.0.0 for stable code 

on:
  push:
    branches:
      - main
    paths:
      - 'examples/**'
  pull_request:
    branches:
      - main
    paths:
      - 'examples/**'
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
  LoadCodeBase:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print Java version from setup
        run: echo "Using Java 17"

      - name: Download jmzTab-m CLI
        id: download_cli
        run: |
          VERSION="1.0.6"
          CLI_URL="https://repo1.maven.org/maven2/de/isas/mztab/jmztabm-cli/${VERSION}/jmztabm-cli-${VERSION}.jar"
          echo "Downloading jmzTab-m CLI version ${VERSION}..."
          wget -q "${CLI_URL}" -O jmztabm-cli-${VERSION}.jar
          echo "Downloaded jmzTab-m CLI jar: jmztabm-cli-${VERSION}.jar"
      - name: Upload CLI jar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jmztab-cli
          path: jmztabm-cli-*.jar
          
  MetabolightsValidation:
    runs-on: ubuntu-latest
    needs: LoadCodeBase
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download CLI jar
        uses: actions/download-artifact@v4
        with:
          name: jmztab-cli
          path: .

      - name: Verify CLI jar
        run: ls -lh
        
      - name: Validate all 'mtbls*' files
        run: |
          set +e  # Don't exit immediately on error
          CLI_JAR=$(ls jmztabm-cli-*.jar | head -n 1)
          echo "Using CLI jar: $CLI_JAR"
          # Check if any files match the pattern
          FILES=(examples/mtbls*)
          if [ ! -e "${FILES[0]}" ]; then
            echo "::warning title=No files found::No files matching 'examples/mtbls*' were found."
          fi
          FAIL_COUNT=0
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              java -jar "$CLI_JAR" -c "$file" -l Info
              EXIT_CODE=$?
              if [ $EXIT_CODE -ne 0 ]; then
                echo "::error title=Validation failed::$file failed validation with exit code $EXIT_CODE"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              else
                echo "Validation of $file completed successfully!"
              fi
            fi
          done
          echo "Number of failed validations: $FAIL_COUNT"
            if [ $FAIL_COUNT -ne 0 ]; then
              echo "::error title=Validation summary::$FAIL_COUNT file(s) failed validation."
              exit 1
            fi
  ManualFilesValidation:
    runs-on: ubuntu-latest
    needs: LoadCodeBase
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download CLI jar
        uses: actions/download-artifact@v4
        with:
          name: jmztab-cli
          path: .

      - name: Verify CLI jar
        run: ls -lh
        
      - name: Validate all 'manual*' files
        run: |
          set +e  # Don't exit immediately on error
          CLI_JAR=$(ls jmztabm-cli-*.jar | head -n 1)
          echo "Using CLI jar: $CLI_JAR"
          # Check if any files match the pattern
          FILES=(examples/manual*)
          if [ ! -e "${FILES[0]}" ]; then
            echo "::warning title=No files found::No files matching 'examples/manual*' were found."
          fi
          FAIL_COUNT=0
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              java -jar "$CLI_JAR" -c "$file" -l Info
              EXIT_CODE=$?
              if [ $EXIT_CODE -ne 0 ]; then
                echo "::error title=Validation failed::$file failed validation with exit code $EXIT_CODE"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              else
                echo "Validation of $file completed successfully!"
              fi
            fi
          done
          echo "Number of failed validations: $FAIL_COUNT"
            if [ $FAIL_COUNT -ne 0 ]; then
              echo "::error title=Validation summary::$FAIL_COUNT file(s) failed validation."
              exit 1
            fi
  MS-DIALValidation:
    runs-on: ubuntu-latest
    needs: LoadCodeBase
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download CLI jar
        uses: actions/download-artifact@v4
        with:
          name: jmztab-cli
          path: .

      - name: Verify CLI jar
        run: ls -lh

      - name: Validate all 'msdial*' files
        run: |
          set +e  # Don't exit immediately on error
          CLI_JAR=$(ls jmztabm-cli-*.jar | head -n 1)
          echo "Using CLI jar: $CLI_JAR"
          # Check if any files match the pattern
          FILES=(examples/msdial*)
          if [ ! -e "${FILES[0]}" ]; then
            echo "::warning title=No files found::No files matching 'examples/msdial*' were found."
          fi
          FAIL_COUNT=0
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              java -jar "$CLI_JAR" -c "$file" -l Info
              EXIT_CODE=$?
              if [ $EXIT_CODE -ne 0 ]; then
                echo "::error title=Validation failed::$file failed validation with exit code $EXIT_CODE"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              else
                echo "Validation of $file completed successfully!"
              fi
            fi
          done
          echo "Number of failed validations: $FAIL_COUNT"
            if [ $FAIL_COUNT -ne 0 ]; then
              echo "::error title=Validation summary::$FAIL_COUNT file(s) failed validation."
              exit 1
            fi
  MZMINEValidation:
    runs-on: ubuntu-latest
    needs: LoadCodeBase
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download CLI jar
        uses: actions/download-artifact@v4
        with:
          name: jmztab-cli
          path: .

      - name: Verify CLI jar
        run: ls -lh

      - name: Validate multiple 'mzmine*' files
        run: |
          set +e  # Don't exit immediately on error
          CLI_JAR=$(ls jmztabm-cli-*.jar | head -n 1)
          echo "Using CLI jar: $CLI_JAR"
          # Check if any files match the pattern
          FILES=(examples/mzmine*)
          if [ ! -e "${FILES[0]}" ]; then
            echo "::warning title=No files found::No files matching 'examples/mzmine*' were found."
          fi
          FAIL_COUNT=0
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              java -jar "$CLI_JAR" -c "$file" -l Info
              EXIT_CODE=$?
              if [ $EXIT_CODE -ne 0 ]; then
                echo "::error title=Validation failed::$file failed validation with exit code $EXIT_CODE"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              else
                echo "Validation of $file completed successfully!"
              fi
            fi
          done
          echo "Number of failed validations: $FAIL_COUNT"
            if [ $FAIL_COUNT -ne 0 ]; then
              echo "::error title=Validation summary::$FAIL_COUNT file(s) failed validation."
              exit 1
            fi
  AllMZTABFilesValidation:
    runs-on: ubuntu-latest
    needs: LoadCodeBase
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download CLI jar
        uses: actions/download-artifact@v4
        with:
          name: jmztab-cli
          path: .

      - name: Verify CLI jar
        run: ls -lh
        
      - name: Validate all '*.mztab' files
        run: |
          set +e  # Don't exit immediately on error
          CLI_JAR=$(ls jmztabm-cli-*.jar | head -n 1)
          echo "Using CLI jar: $CLI_JAR"
          # Check if any files match the pattern
          FILES=(examples/*.mztab)
          if [ ! -e "${FILES[0]}" ]; then
            echo "::warning title=No files found::No files matching 'examples/.*mztab' were found."
          fi
          FAIL_COUNT=0
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              java -jar "$CLI_JAR" -c "$file" -l Info
              EXIT_CODE=$?
              if [ $EXIT_CODE -ne 0 ]; then
                echo "::error title=Validation failed::$file failed validation with exit code $EXIT_CODE"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              else
                echo "Validation of $file completed successfully!"
              fi
            fi
          done
          echo "Number of failed validations: $FAIL_COUNT"
            if [ $FAIL_COUNT -ne 0 ]; then
              echo "::error title=Validation summary::$FAIL_COUNT file(s) failed validation."
              exit 1
            fi      
      
  AllJSONFilesValidation:
    runs-on: ubuntu-latest
    needs: LoadCodeBase
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download CLI jar
        uses: actions/download-artifact@v4
        with:
          name: jmztab-cli
          path: .

      - name: Verify CLI jar
        run: ls -lh
        
      - name: Validate all '*.json' files
        run: |
          set +e  # Don't exit immediately on error
          CLI_JAR=$(ls jmztabm-cli-*.jar | head -n 1)
          echo "Using CLI jar: $CLI_JAR"
          # Check if any files match the pattern
          FILES=(examples/*.json)
          if [ ! -e "${FILES[0]}" ]; then
            echo "::warning title=No files found::No files matching 'examples/.*json' were found."
          fi
          FAIL_COUNT=0
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              java -jar "$CLI_JAR" -c "$file" --fromJson -l Info
              EXIT_CODE=$?
              if [ $EXIT_CODE -ne 0 ]; then
                echo "::error title=Validation failed::$file failed validation with exit code $EXIT_CODE"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              else
                echo "Validation of $file completed successfully!"
              fi
            fi
          done
          echo "Number of failed validations: $FAIL_COUNT"
          if [ $FAIL_COUNT -ne 0 ]; then
             echo "::error title=Validation summary::$FAIL_COUNT file(s) failed validation."
             exit 1
          else
             echo "All JSON files validated successfully."
          fi
