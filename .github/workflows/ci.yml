name: Spec Build Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DOC_IN: "${{ github.workspace }}/specification_documents"
  DOC_OUT: "${{ github.workspace }}/specification_documents/output"
  DOC_FILE: 'mzTab_format_specification_2_1-M.adoc'
  RELEASE_DIR: '2_1-metabolomics-release'

jobs:
  build-spec:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set build timestamp
        run: echo "BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
      
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y pandoc
      
      - name: Pull Asciidoctor Docker image
        run: docker pull asciidoctor/docker-asciidoctor:1
      
      - name: Build specification documents
        run: |
          ./build-docs.sh \
            -i "$DOC_IN" \
            -o "$DOC_OUT" \
            -c "$GITHUB_SHA" \
            -d "$BUILD_DATE" \
            -f "$DOC_FILE"
        shell: bash
      
      - name: Prepare output directory
        run: |
          mkdir -p output/$RELEASE_DIR/img
          cp -v -R $DOC_OUT/* output/$RELEASE_DIR/
          cp -v -R $DOC_OUT/img/* output/$RELEASE_DIR/img/
          cp -v -R docs/* output/
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: specification-documents
          path: |
            output/${{ env.RELEASE_DIR }}/*.pdf
            output/${{ env.RELEASE_DIR }}/*.html
            output/${{ env.RELEASE_DIR }}/*.docx
          retention-days: 90
