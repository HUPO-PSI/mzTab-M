name: Validate v2.0.0 Snapshot

on:
  push:
    branches:
      - main
    paths:
      - 'examples/**'
  pull_request:
    branches:
      - main
    paths:
      - 'examples/**'
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  # Note: The version is set in the 'Download' step's script
  # CLI_VERSION: '1.0.7-SNAPSHOT'

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

  LoadCodeBase:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print Java version from setup
        run: echo "Using Java ${{ env.JAVA_VERSION }}"

      - name: Download and extract jmzTab-m CLI
        id: download_cli
        run: |
          # This version matches the dev snapshot
          VERSION="1.0.7-SNAPSHOT"

          # Snapshots are on Sonatype OSSRH with a different group ID (org.lifs-tools)
          # The snapshot is distributed as a -bin.zip bundle
          CLI_URL="https://oss.sonatype.org/content/repositories/snapshots/org/lifs-tools/jmztabm-cli/${VERSION}/jmztabm-cli-${VERSION}-bin.zip"
          ZIP_FILE="jmztabm-cli-snapshot.zip"
          UNZIP_DIR="jmztabm-cli-snapshot-bundle"

          echo "Downloading jmzTab-m CLI version ${VERSION} from ${CLI_URL}..."
          wget -q "${CLI_URL}" -O "${ZIP_FILE}"

          if [ ! -s "${ZIP_FILE}" ]; then
            echo "::error::Download failed or file is empty. Check URL: ${CLI_URL}"
            exit 1
          fi

          echo "Downloaded CLI zip: ${ZIP_FILE}"

          echo "Unpacking ${ZIP_FILE} to ${UNZIP_DIR}..."
          mkdir -p "${UNZIP_DIR}"
          unzip -q "${ZIP_FILE}" -d "${UNZIP_DIR}"

          # Find the single JAR file inside the unzipped bundle
          # and move it to the root for artifact upload
          CLI_JAR=$(find "${UNZIP_DIR}" -name "jmztabm-cli-*.jar" | head -n 1)

          if [ -f "$CLI_JAR" ]; then
            echo "Found CLI JAR: $CLI_JAR"
            # Move it to the current directory to be uploaded
            mv "$CLI_JAR" .
            echo "Moved JAR to root for upload."
            ls -lh jmztabm-cli-*.jar
          else
            echo "::error::Could not find jmztabm-cli-*.jar in the downloaded zip."
            # List contents for debugging
            ls -lR "${UNZIP_DIR}"
            exit 1
          fi

      - name: Upload CLI jar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jmztab-cli
          path: jmztabm-cli-*.jar # This will now match the extracted JAR
