name: Validate v2.0.0 Snapshot

on:
  push:
    branches:
      - main
    paths:
      - 'examples/**'
  pull_request:
    branches:
      - main
    paths:
      - 'examples/**'
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

  LoadCodeBase:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print Java version from setup
        run: echo "Using Java ${{ env.JAVA_VERSION }}"

      - name: Download jmzTab-m CLI (Snapshot)
        id: download_cli
        run: |
          VERSION_BASE="1.0.7-SNAPSHOT"
          ARTIFACT_ID="jmztabm-cli"

          # 1. Download the metadata file that contains the *actual* timestamped filenames
          METADATA_URL="https://m.lifs-tools.org/artifactory/libs-snapshot/org/lifs-tools/${ARTIFACT_ID}/${VERSION_BASE}/maven-metadata.xml"
          echo "Downloading metadata from ${METADATA_URL}..."
          wget --no-check-certificate -q "${METADATA_URL}" -O "maven-metadata.xml"

          if [ ! -s "maven-metadata.xml" ]; then
            echo "::error::Could not download maven-metadata.xml. Check URL: ${METADATA_URL}"
            exit 1
          fi

          # 2. Parse the metadata to find the full version string for the 'bin.jar'
          # We look for the <snapshotVersion> block with <classifier>bin</classifier>
          # and <extension>jar</extension>, then get its <value>
          echo "Parsing metadata..."
          LITERAL_VERSION=$(grep -A 2 '<classifier>bin</classifier>' maven-metadata.xml | grep '<value>' | sed 's/.*<value>\(.*\)<\/value>.*/\1/')

          if [ -z "$LITERAL_VERSION" ]; then
            echo "::error::Could not parse snapshot version from maven-metadata.xml. File contents:"
            cat maven-metadata.xml
            exit 1
          fi

          echo "Found literal version: ${LITERAL_VERSION}"

          # 3. Construct the full file name and URL
          FILE_NAME="${ARTIFACT_ID}-${LITERAL_VERSION}-bin.jar"
          CLI_URL="https://m.lifs-tools.org/artifactory/libs-snapshot/org/lifs-tools/${ARTIFACT_ID}/${VERSION_BASE}/${FILE_NAME}"

          # 4. Download the actual file
          echo "Downloading final artifact: ${CLI_URL}"
          wget --no-check-certificate -q "${CLI_URL}" -O "${FILE_NAME}"

          # 5. Check and rename
          if [ ! -s "${FILE_NAME}" ]; then
            echo "::error::Download failed or file is empty. Check URL: ${CLI_URL}"
            exit 1
          fi

          echo "Download complete. Verifying file:"
          ls -lh "${FILE_NAME}"

          # Create a symlink with a predictable name for the upload wildcard
          # This helps if there are other jars in the directory
          ln -s "${FILE_NAME}" jmztabm-cli-snapshot-latest.jar

      - name: Upload CLI jar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jmztab-cli
          # This path will now pick up the symlinked file
          path: jmztabm-cli-snapshot-latest.jar
