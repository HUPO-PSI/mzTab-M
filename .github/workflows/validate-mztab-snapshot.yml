LoadCodeBase:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print Java version from setup
        run: echo "Using Java ${{ env.JAVA_VERSION }}"

      - name: Download jmzTab-m CLI (Snapshot)
        id: download_cli
        run: |
          echo "Downloading jmzTab-m CLI 1.0.7-SNAPSHOT bundle using Maven..."

          # The error 'Could not find artifact' for the JAR suggests
          # we need to download the full distribution bundle (bin.zip)
          # and extract the JAR from it. We specify ':zip:bin' as the artifact type.

          mvn org.apache.maven.plugins:maven-dependency-plugin:3.7.1:copy \
            -DrepoUrl=https://m.lifs-tools.org/artifactory/libs-snapshot \
            -Dartifact=org.lifs-tools:jmztabm-cli:1.0.7-SNAPSHOT:zip:bin \
            -DoutputDirectory=.

          echo "Download complete. Verifying and extracting file:"
          ls -lh *.zip

          # Unzip the bundle
          ZIP_FILE=$(ls jmztabm-cli-*-bin.zip)
          UNZIP_DIR="jmztabm-cli-bundle"
          mkdir -p "${UNZIP_DIR}"
          unzip -q "${ZIP_FILE}" -d "${UNZIP_DIR}"

          echo "Bundle extracted. Searching for standalone JAR..."

          # Find the actual JAR file within the bundle
          # It might be in a 'lib' folder or the root of the unzipped dir
          CLI_JAR=$(find "${UNZIP_DIR}" -name "jmztabm-cli-*.jar" | head -n 1)

          if [ -f "$CLI_JAR" ]; then
            echo "Found CLI JAR: $CLI_JAR"
            # Move it to the current directory to be uploaded
            mv "$CLI_JAR" .
            echo "Moved JAR to root for upload."
            ls -lh jmztabm-cli-*.jar
          else
            echo "::error::Could not find jmztabm-cli-*.jar in the downloaded zip."
            # List contents for debugging
            ls -lR "${UNZIP_DIR}"
            exit 1
          fi

      - name: Upload CLI jar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jmztab-cli
          # This wildcard path will match the extracted JAR
          path: jmztabm-cli-*.jar
